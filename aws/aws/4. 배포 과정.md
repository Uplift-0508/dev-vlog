# 배포 과정

## 무중단/중단 배포
무중단 배포와 중단 배포는 용어 그대로 보면, 배포할 때 서비스 중단 여부에 차이가 있습니다. 서비스를 중단하지 않는다는 것은 사용자들이 서비스를 사용하는 데 아무런 지장 없이 배포를 진행하는 것을 뜻합니다. 중단 배포는 서버 정기 점검 으로 사용자가 서비스를 사용하지 못하게 시스템 전체를 정지한 뒤 배포를 진행하는 것을 뜻합니다.

중단 배포를 하는 이유는, 한 서비스에서 애플리케이션 코드나 데이터베이스 스키마 등 구버전과 신버전이 동시에 서비스되면 안 되는 경우에는 중단 배포를 하거나 별도 처리를 해야 합니다. 

A, B 라는 두 기능을 제공하는 서비스에서 A, B 기능에 아무런 영향을 주지 않는 C 기능이 추가된 경우에는 무중단 배포를 해도 아무런 문제가 없습니다. 하지만 B 기능이 사용하는 테이블이 다른 테이블로 변경됐다면 과거의 테이블을 사용하는 코드를 서비스하는 서버와 새로운 테이블을 사용하는 코드를 서비스하는 서버가 동시에 떠 있는 경우 데이터베이스의 정합성이 깨지게 됩니다. 혹은 B 기능이 바라보는 테이블의 스키마가 완전히 변경됐다면 과거 테이블 스키마를 사용하도록 만들어진 코드를 가진 서버 인스턴스에서는 에러가 발생할 것입니다. 이런 경우에는 중단 배포를 진행하거나 무중단 배포를 위해 변경 사항을 저장해두는 임시 테이블을 만들어서 차이 값을 마이그레이션하는 방법을 택해야 합니다.

### 현재 위치 배포 (In-place deployment)

1. 모든 서버가 v1.0.1 버전으로 서비스하고 있습니다.
![enter image description here](https://camo.githubusercontent.com/8513225fc7b6c8f136a836635a42e2d162f66494/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d444e664d6a67792f4d4441784e5455304d6a677a4d4455774e54677a2e4f7765494558714274415465676757337950584e566f79656c595a6a616e57686f48453977534c70395059672e6a6f7251636f77486863306d335a5556716c4248785579752d336134775736426a434e47653158554b4677672e504e472e6e696e616e756e672f696e2d706c616365312e706e673f747970653d77373733)

2. 4대 중 2대의 인스턴스를 로드 밸런서에서 제외합니다. 로드 밸런서는 제외된 인스턴스들에게 요청을 보내지 않습니다.
![enter image description here](https://camo.githubusercontent.com/07257f52ec810c13c03b670645fa1463fdf720dd/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d444e664f5445672f4d4441784e5455304d6a677a4d4455774e5467342e53386e50727a646f4365386f4c32732d643553334a525f4e574e4368495651446f643976706d6d4b534551672e677070447354636464545f6d4b39505a7850645a30774e5f5a58694845553965534a3269676b3765724234672e504e472e6e696e616e756e672f696e2d706c616365322e706e673f747970653d77373733)

3. 새로운 요청을 받지 않는 서버 인스턴스에 v1.0.2 버전의 코드를 배포합니다.
![enter image description here](https://camo.githubusercontent.com/37378acb70444f5479617ecc14462735c034e0a9/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d444e664d546b332f4d4441784e5455304d6a677a4d4455774e5467322e4973525450614c5342444c6f3556496d49513535677345544f7231556b62334844524b64584c73454c4873672e50737333344235757638516558635357313667436d7361427143464357663268734139427262582d5a724d672e504e472e6e696e616e756e672f696e2d706c616365332e706e673f747970653d77373733)

4. v1.0.2 버전이 배포된 서버를 다시 로드 밸런서에 등록해서 클라이언트의 요청을 나눠 처리합니다.
![enter image description here](https://camo.githubusercontent.com/d437f34ec59948c98ac155f5d528f3e6a64eee68/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d444e664f4445672f4d4441784e5455304d6a677a4d4455774e5467352e355466667465517336322d625749686c54445474686e794c4a4b4f7056396435786e4e62466b74374a7030672e444f74716369735a55344245483239476c37544337476c477a725467684a66754d696e68525a4944523863672e504e472e6e696e616e756e672f696e2d706c616365342e706e673f747970653d77373733)

5. v1.0.1 버전을 서비스하고 있는 다른 두 서버를 로드 밸런서에서 제외해서 클라이언트의 요청을 받지 않게 합니다.
![enter image description here](https://camo.githubusercontent.com/7a9304b5edaa1e125f5a3112c50fcb0c09a36084/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d444e664e7a6b672f4d4441784e5455304d6a677a4d4455774e5467332e36553063505354776a6d574a6870463167656778497564794f726b5932455773466955686f63516c39396f672e43626336567842306c706f616a42325356434b4f4d7553466c7349716b41626d68494b6b727a3448626334672e504e472e6e696e616e756e672f696e2d706c616365352e706e673f747970653d77373733)

6. 제외된 두 서버에도 v1.0.2 버전의 코드를 배포합니다. 다시 두 서버도 로드 밸런서에 등록해서 클라이언트의 요청을 나눠 받습니다. 
![enter image description here](https://camo.githubusercontent.com/cab2394963e41c7d50ef6007ff22e79a769de068/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d444e664d5463352f4d4441784e5455304d6a677a4d4455774e546b302e5f387255512d7250386b7a30615a465563475039307654666a327a77636241463038754c663856364b4d59672e4363442d39783263764e2d526935454f37487744714e6b5879427a76424332566d5039346e474e67336459672e504e472e6e696e616e756e672f696e2d706c616365362e706e673f747970653d77373733)

현재 위치 배포 (In-place deployment) 는 무중단 배포를 하기 위한 기법의 하나로 여러 대의 서버를 배포할 때 새롭게 서버를 생성하거나 줄이지 않고 배포하는 방법을 의미합니다. 배포 중에는 클라이언트의 요청을 처리할 수 있는 인스턴스의 수가 준다는 점에 유의해야 합니다. 만약 줄어든 인스턴스 수로 전체 요청량을 처리하는 데 무리가 있다면 시간이 조금 더 걸리더라도 여유 인스턴스를 추가한 뒤 배포를 진행하는 편이 안전합니다. 

만약 한 번에 하나씩 배포를 진행하면 앞서 나왔던 요청량의 처리 문제는 많이 줄어들겠지만, 배포를 진행하는 데 시간이 더 오래 걸립니다. 그리고 현재 위치 배포는 배포한 버전에 문제가 있어 이전 버전으로 롤백해야 하는 경우 이전 버전으로 배포를 다시 진행해야 하므로 대응하는 데 시간이 오래 걸린다는 단점이 있습니다. 

### 서버 단위의 블루/그린 배포 (Blue/Green deployment)

![enter image description here](https://camo.githubusercontent.com/06667752db721c4b284e421043a5d5685cfa774b/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d4452664d7941672f4d4441784e5455304d7a55334d444d794d5449302e5f5049494e6f64624d3151697379417633636765726a2d6d3136746f5638426463565862787553585f416b672e577458367a456853477a733264777136515a656d4b6b6d796752594a4b6534794c3156554f4c4d39444e55672e504e472e6e696e616e756e672f626c75653a677265656e5f312e706e673f747970653d77373733)

![enter image description here](https://camo.githubusercontent.com/156d9f2469a1ae8160bcdf27d1dfb9817c90339b/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d4452664d54597a2f4d4441784e5455304d7a55334d444d794d5449322e7761686239375843534552546943325a76725253304e4848575a5567374d37514a576a7353694153575951672e4e675678506b4444566d326972483834414c71527465546369375f4e645875545542446e2d77774b536b30672e504e472e6e696e616e756e672f626c75653a677265656e5f322e706e673f747970653d77373733)

![enter image description here](https://camo.githubusercontent.com/b030ea8dd69734e887abae62089198671b5c37e0/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d4452664d5463342f4d4441784e5455304d7a55334d444d794d5449332e47776f445466627851416873635252646333664c52737168715a6f61506c3766696c7a412d496b63386e38672e61465559756f745f4974626178613768556f564448325756494e4134574a335764394530574950636c3638672e504e472e6e696e616e756e672f626c75653a677265656e5f332e706e673f747970653d77373733)

![enter image description here](https://camo.githubusercontent.com/88e58b76f7b796194657caf178986f62e6f87bd8/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d4452664d5463782f4d4441784e5455304d7a55334d444d794d544d772e475534703856437567714767516a7774734c656d413246324a635a526b787062597949746a496f4f616355672e646870425250564a5170513938453968374665626f4b6f4e5939613830584f6e5038595234442d65594938672e504e472e6e696e616e756e672f626c75653a677265656e5f342e706e673f747970653d77373733)

![enter image description here](https://camo.githubusercontent.com/b8e6f74f4f3d77481865050202d46ff223bd4539/68747470733a2f2f706f737466696c65732e707374617469632e6e65742f4d6a41784f5441304d4452664d6a67312f4d4441784e5455304d7a55334d444d794d5449342e2d7759303934534f697878307461735a7a62795a6c5161465364326f78756e714f77456a6b2d4e4558676f672e4d33353643367233723730713450724c794c46564c686b514a726445654e326c5f7a75426654494d793538672e504e472e6e696e616e756e672f626c75653a677265656e5f352e706e673f747970653d77373733)

끝으로 블루 그룹 내 존재하는 인스턴스들을 모두 종료해서 배포를 완료합니다.

블루/그린 배포는 현재 위치 배포와 다른 장단점을 갖고 있습니다.

1. 구, 신버전이 동시에 떠 있는 시간을 매우 짧게 처리할 수 있습니다. 현재 위치 배포는 모든 인스턴스가 차례대로 배포될 때까지 비교적 많은 시간이 걸리기 때문에 구버전과 신버전이 동시에 떠 있는 시간이 깁니다. 그에 반해 블루/그린 배포는 최신 버전의 코드를 배포한 서버들이 모두 준비돼 있기 때문에 짧은 시간에 로드 밸런서에 등록, 제외해서 구버전과 신버전이 동시에 떠 있는 시간을 줄일 수 있습니다. 물론 무중단 배포의 가장 기본 원칙은 구버전과 신버전이 동시에 떠 있어도 아무런 문제가 없어야 한다는 것이지만, 두 버전이 동시에 떠 있어서 발생하는 예상치 못한 장애의 위험 부담을 더 줄일 수 있습니다.
2. 롤백을 굉장히 빨리 할 수 있습니다. 현재 위치 배포는 롤백이라는 개념이 다시 구버전을 배포하는 것이지만, 블루/그린 배포는 로드 밸런서에 등록, 해제만 하면 되므로 굉장히 빨리 롤백을 진행할 수 있습니다. 그래서 실제로 블루 그룹에서 서비스하다 그린 그룹으로 배포를 완료해도 블루 그룹의 인스턴스를 바로 줄이지 않습니다. 몇 시간 정도 모니터링 진행하다 문제가 확실히 없다고 판단되면 그때 블루 그룹의 인스턴스들을 모두 종료하면 됩니다.
3. 배포 과정에서 서비스되는 인스턴스의 수가 줄지 않으므로 요청량을 처리하는 데서 오는 장애의 부담이 없습니다. 
4. 인스턴스의 수를 두 배로 늘려야하므로 인스턴스를 하나도 더 생성하지 않아도 되는 현재 위치 배포에 비해 배포를 준비하는 데 시간이 더 오래 걸릴 수 있습니다.

다시 정리하면, in-placement(현재 위치) 배포와 블루/그린 배포는 둘 다 무중단으로 배포를 진행할 수 있는 효과적인 방법ㅇ
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTQ5ODc1NzgyMSwtMTIwMDYzNzMwMSwxMD
g5MjMxNzMxXX0=
-->